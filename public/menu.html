<script>
  // Show current user
  fetch("/me")
    .then(res => res.json())
    .then(data => {
      window.isAdmin = data.is_admin;

      const welcome = document.getElementById("welcome");
      if (data.loggedIn) {
        welcome.textContent = "Logged in as " + data.username +
          (data.is_admin ? " (admin)" : "");
      }

      // ✅ Fix: pre-check attendance box
      document.getElementById("attendingBox").checked = data.attending;
    });

  // Load dishes
  function loadDishes() {
    fetch("/dishes")
      .then(res => res.json())
      .then(dishes => {
        const list = document.getElementById("dish-list");
        list.innerHTML = "";

        dishes.forEach(dish => {
          const li = document.createElement("li");
          li.className = "dish-item";

          const nameSpan = document.createElement("span");
          nameSpan.textContent = dish.name;

          const rightDiv = document.createElement("div");
          rightDiv.className = "dish-actions";

          if (dish.claimed_by) {
            const claimedSpan = document.createElement("span");
            claimedSpan.className = "tag claimed";
            claimedSpan.textContent = "Brought by " + dish.claimed_by;
            rightDiv.appendChild(claimedSpan);

            const form = document.createElement("form");
            form.method = "POST";
            form.action = "/unclaim-dish";

            const hidden = document.createElement("input");
            hidden.type = "hidden";
            hidden.name = "dishId";
            hidden.value = dish.id;
            form.appendChild(hidden);

            const btn = document.createElement("button");
            btn.type = "submit";
            btn.className = "button small secondary";
            btn.textContent = "I’m not bringing this";
            form.appendChild(btn);

            rightDiv.appendChild(form);
          } else {
            const form = document.createElement("form");
            form.method = "POST";
            form.action = "/claim-dish";

            const hidden = document.createElement("input");
            hidden.type = "hidden";
            hidden.name = "dishId";
            hidden.value = dish.id;
            form.appendChild(hidden);

            const btn = document.createElement("button");
            btn.type = "submit";
            btn.className = "button small";
            btn.textContent = "I’ll bring this";
            form.appendChild(btn);

            rightDiv.appendChild(form);
          }

          // If admin, show delete button
          if (window.isAdmin) {
            const form = document.createElement("form");
            form.method = "POST";
            form.action = "/delete-dish";

            const hidden = document.createElement("input");
            hidden.type = "hidden";
            hidden.name = "dishId";
            hidden.value = dish.id;
            form.appendChild(hidden);

            const btn = document.createElement("button");
            btn.type = "submit";
            btn.className = "button small secondary";
            btn.textContent = "Delete";
            form.appendChild(btn);

            rightDiv.appendChild(form);
          }

          li.appendChild(nameSpan);
          li.appendChild(rightDiv);
          list.appendChild(li);
        });
      });
  }

  loadDishes();
</script>
