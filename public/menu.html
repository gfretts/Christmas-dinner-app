<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Christmas Dinner Menu</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="top-bar">
    <div class="top-bar-left">
      <h1>ðŸŽ„ Fretts Roberts(on) Christmas Dinner Menu</h1>
    </div>
    <div class="top-bar-right">
      <span id="welcome"></span>
      <a href="/logout" class="button small secondary">Log out</a>
    </div>
  </div>

  <div class="container">

    <!-- Attendance Section -->
    <section class="card">
      <h2>Attendance</h2>
      <form method="POST" action="/set-attending">
        <label class="checkbox">
          <input type="checkbox" name="attending" value="1" id="attendingBox">
          I will attend
        </label>
        <button class="button small" type="submit">Save</button>
      </form>
    </section>

    <!-- Add Dish Section -->
    <section class="card">
      <h2>Add a dish</h2>
      <form action="/add-dish" method="POST" class="inline-form">
        <input type="text" name="name" placeholder="e.g. Mashed potatoes" required>
        <button type="submit" class="button">Add</button>
      </form>
      <p class="muted">Add anything: mains, sides, desserts, drinks.</p>
    </section>

    <!-- Menu Section -->
    <section class="card">
      <h2>Menu & whoâ€™s bringing what</h2>
      <ul id="dish-list" class="dish-list"></ul>
    </section>

    <!-- Attendance List Section -->
    <section class="card">
      <h2>Whoâ€™s attending</h2>
      <ul id="attending-list" class="dish-list"></ul>

      <h3 style="margin-top:20px;">Not attending</h3>
      <ul id="not-attending-list" class="dish-list"></ul>
    </section>

  </div>

  <script>
    // Load current user info
    fetch("/me")
      .then(res => res.json())
      .then(data => {
        window.isAdmin = data.is_admin;

        const welcome = document.getElementById("welcome");
        if (data.loggedIn) {
          welcome.textContent = "Logged in as " + data.username +
            (data.is_admin ? " (admin)" : "");
        }
	if (data.is_admin) {
  	  const adminLink = document.createElement("a");
  	  adminLink.href = "/admin.html";
  	  adminLink.textContent = "Admin Panel";
  	  document.body.appendChild(adminLink);
	}

        // âœ… Pre-check attendance box
        document.getElementById("attendingBox").checked = data.attending;
      });

    // Load dishes
    function loadDishes() {
      fetch("/dishes")
        .then(res => res.json())
        .then(dishes => {
          const list = document.getElementById("dish-list");
          list.innerHTML = "";

          dishes.forEach(dish => {
            const li = document.createElement("li");
            li.className = "dish-item";

            const nameSpan = document.createElement("span");
            nameSpan.textContent = dish.name;

            const rightDiv = document.createElement("div");
            rightDiv.className = "dish-actions";

            if (dish.claimed_by) {
              const claimedSpan = document.createElement("span");
              claimedSpan.className = "tag claimed";
              claimedSpan.textContent = "Brought by " + dish.claimed_by;
              rightDiv.appendChild(claimedSpan);

              const form = document.createElement("form");
              form.method = "POST";
              form.action = "/unclaim-dish";

              const hidden = document.createElement("input");
              hidden.type = "hidden";
              hidden.name = "dishId";
              hidden.value = dish.id;
              form.appendChild(hidden);

              const btn = document.createElement("button");
              btn.type = "submit";
              btn.className = "button small secondary";
              btn.textContent = "Iâ€™m not bringing this";
              form.appendChild(btn);

              rightDiv.appendChild(form);
            } else {
              const form = document.createElement("form");
              form.method = "POST";
              form.action = "/claim-dish";

              const hidden = document.createElement("input");
              hidden.type = "hidden";
              hidden.name = "dishId";
              hidden.value = dish.id;
              form.appendChild(hidden);

              const btn = document.createElement("button");
              btn.type = "submit";
              btn.className = "button small";
              btn.textContent = "Iâ€™ll bring this";
              form.appendChild(btn);

              rightDiv.appendChild(form);
            }

            // âœ… Admin delete button
            if (window.isAdmin) {
              const form = document.createElement("form");
              form.method = "POST";
              form.action = "/delete-dish";

              const hidden = document.createElement("input");
              hidden.type = "hidden";
              hidden.name = "dishId";
              hidden.value = dish.id;
              form.appendChild(hidden);

              const btn = document.createElement("button");
              btn.type = "submit";
              btn.className = "button small secondary";
              btn.textContent = "Delete";
              form.appendChild(btn);

              rightDiv.appendChild(form);
            }

            li.appendChild(nameSpan);
            li.appendChild(rightDiv);
            list.appendChild(li);
          });
        });
    }

    // Load attendance lists
    function loadAttendance() {
      fetch("/users")
        .then(res => res.json())
        .then(users => {
          const attendingList = document.getElementById("attending-list");
          const notAttendingList = document.getElementById("not-attending-list");

          attendingList.innerHTML = "";
          notAttendingList.innerHTML = "";

          users.forEach(user => {
            const li = document.createElement("li");
            li.className = "dish-item";
            li.textContent = user.username;

            if (user.attending === 1) {
              attendingList.appendChild(li);
            } else {
              notAttendingList.appendChild(li);
            }
          });
        });
    }

    loadDishes();
    loadAttendance();
  </script>
</body>
</html>